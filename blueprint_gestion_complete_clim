blueprint:
  name: Gestion complète clim
  description: >
    Allume une clim selon horaire ou température, coupe après un timer configurable,
    sécurité à 01h, arrêt automatique à 08h, et ne fonctionne que si présence + entre 19h et 08h.
  domain: automation

  input:
    climate_entity:
      name: Climatisation
      selector:
        entity:
          domain: climate

    temp_sensor:
      name: Capteur de température
      selector:
        entity:
          domain: sensor

    presence_group:
      name: Groupe de présence
      selector:
        entity:
          domain: group

    seuil_temperature:
      name: Seuil de déclenchement température
      default: 16
      selector:
        number:
          min: 5
          max: 25
          step: 0.5

    consigne_temperature:
      name: Température de consigne
      default: 19
      selector:
        number:
          min: 10
          max: 30
          step: 0.5

    heure_on:
      name: Heure d’allumage programmée
      default: "19:00:00"
      selector:
        time: {}

    heure_securite:
      name: Heure sécurité OFF
      default: "01:00:00"
      selector:
        time: {}

    heure_off_matin:
      name: Heure arrêt du matin
      default: "08:00:00"
      selector:
        time: {}

    duree_fonctionnement:
      name: Durée avant extinction automatique (timer)
      default: "02:00:00"
      selector:
        duration: {}

    timer_entity:
      name: Timer utilisé pour la clim
      description: >
        Choisissez un timer Home Assistant (à créer dans configuration.yaml ou via l’UI).
      selector:
        entity:
          domain: timer

triggers:
  - trigger: time
    at: !input heure_on
    id: soir_on

  - trigger: numeric_state
    entity_id: !input temp_sensor
    below: !input seuil_temperature
    id: temp_basse

  - trigger: time
    at: !input heure_securite
    id: securite_off

  - trigger: time
    at: !input heure_off_matin
    id: matin_off

  - trigger: state
    entity_id: !input presence_group
    to: "home"
    id: home

  - trigger: event
    event_type: timer.finished
    event_data:
      entity_id: !input timer_entity
    id: timer_fini

conditions:
  # Présence obligatoire
  - condition: state
    entity_id: !input presence_group
    state: "home"

actions:
  - choose:

      # --- Allumage par horaire ou température ---
      - conditions:
          - condition: trigger
            id:
              - soir_on
              - temp_basse
          # Fonctionnement uniquement entre 19h et 08h
          - condition: or
            conditions:
              - condition: time
                after: "19:00:00"
              - condition: time
                before: "08:00:00"
        sequence:
          - action: climate.set_temperature
            target:
              entity_id: !input climate_entity
            data:
              temperature: !input consigne_temperature
              hvac_mode: heat

          - action: timer.start
            target:
              entity_id: !input timer_entity
            data:
              duration: !input duree_fonctionnement

      # --- Allumage par retour à la maison ---
      - conditions:
          - condition: trigger
            id: home
          - condition: time
            after: !input heure_on
            before: "05:00:00"
        sequence:
          - action: climate.set_temperature
            target:
              entity_id: !input climate_entity
            data:
              temperature: !input consigne_temperature
              hvac_mode: heat

          - action: timer.start
            target:
              entity_id: !input timer_entity
            data:
              duration: !input duree_fonctionnement

      # --- Arrêt sécurité ou matin ---
      - conditions:
          - condition: trigger
            id:
              - securite_off
              - matin_off
        sequence:
          - action: climate.turn_off
            target:
              entity_id: !input climate_entity
          - action: timer.cancel
            target:
              entity_id: !input timer_entity

      # --- Arrêt automatique à la fin du timer ---
      - conditions:
          - condition: trigger
            id: timer_fini
        sequence:
          - action: climate.turn_off
            target:
              entity_id: !input climate_entity

      # --- Allumage manuel ---
      - conditions:
          - condition: template
            value_template: "{{ trigger is none }}"
        sequence:
          - action: climate.set_temperature
            target:
              entity_id: !input climate_entity
            data:
              temperature: !input consigne_temperature
              hvac_mode: heat

          - action: timer.start
            target:
              entity_id: !input timer_entity
            data:
              duration: !input duree_fonctionnement

mode: single
